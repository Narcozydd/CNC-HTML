<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini PCB CNC Milling Machine - Lab Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f5f5f4; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a29e; }

        /* Chart Container Classes */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container { height: 350px; }
        }

        /* Interactive Circuit Nodes */
        .circuit-node {
            transition: all 0.3s ease;
        }
        .circuit-node:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .active-tab {
            border-bottom: 2px solid #0d9488;
            color: #0f766e;
            font-weight: 600;
        }
    </style>
    <!-- Chosen Palette: Warm Stone & Teal
         Background: bg-stone-50 (Warm neutral)
         Text: text-stone-800
         Accents: Teal (teal-600) for a technical, lab-safe feel.
         Secondary: Amber (amber-500) for warnings/power.
    -->

    <!-- Application Structure Plan:
         1. Header: Title, Student Info, Abstract.
         2. Navigation: Sticky tabs for logical flow (Overview -> Hardware -> Firmware -> Calibration -> Results).
         3. Content Areas:
            - Overview: Introduction to the project goals.
            - Hardware Architecture: Interactive block diagram of the MKS Gen L setup.
            - Firmware Logic: A "Diff Viewer" to show Marlin changes for CNC mode.
            - Calibration Lab: Interactive calculators for steps/mm and a chart for accuracy testing.
            - Results & Analysis: Cost breakdown and performance discussion.
         4. Footer: References.
         
         Why: This structure mirrors a traditional lab report but breaks it into interactive modules. 
         The instructor can verify the wiring (Hardware), check the code (Firmware), and verify the math (Calibration).
    -->

    <!-- Visualization & Content Choices:
         1. Block Diagram (HTML/CSS): Shows signal flow. Goal: Visualize the circuit.
         2. Code Diff Viewer (JS/HTML): Shows Marlin config changes. Goal: Highlight software modifications.
         3. Steps Calculator (JS): Interactive inputs. Goal: Demonstrate understanding of stepper motor mechanics.
         4. Cost Chart (Chart.js Pie): Breakdown of BOM. Goal: Economic analysis.
         5. Accuracy Chart (Chart.js Bar): Commanded vs Measured. Goal: Performance analysis.
    -->
    
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="bg-stone-50 text-stone-800 antialiased selection:bg-teal-100 selection:text-teal-800">

    <!-- Navigation Bar -->
    <nav class="sticky top-0 z-50 bg-stone-50/95 backdrop-blur border-b border-stone-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-xl font-bold tracking-tight text-teal-700">PCB-CNC Lab Report</span>
                </div>
                <div class="hidden sm:flex sm:space-x-8" id="desktop-nav">
                    <!-- Nav items injected by JS -->
                </div>
                <div class="flex items-center sm:hidden">
                    <button id="mobile-menu-btn" class="p-2 rounded-md text-stone-600 hover:text-stone-900 hover:bg-stone-100">
                        <span class="text-2xl">☰</span>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden sm:hidden bg-white border-b border-stone-200">
            <div class="px-2 pt-2 pb-3 space-y-1" id="mobile-nav-items">
                <!-- Mobile items injected by JS -->
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-16">

        <!-- Header / Abstract Section -->
        <header id="section-overview" class="text-center space-y-6">
            <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-teal-100 text-teal-800">
                Final Laboratory Project
            </div>
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-stone-900">
                Mini PCB CNC Milling Machine
            </h1>
            <div class="max-w-2xl mx-auto text-lg text-stone-600">
                <p>
                    Design and implementation of a low-cost, 3-axis CNC machine for Printed Circuit Board fabrication. 
                    Powered by <strong>MKS Gen L 1.0</strong> and <strong>Marlin Firmware</strong>.
                </p>
            </div>
            
            <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6 text-left">
                <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                    <div class="text-sm text-stone-500 uppercase font-bold tracking-wider mb-2">Controller</div>
                    <div class="font-bold text-xl text-stone-800">MKS Gen L 1.0</div>
                    <p class="text-sm text-stone-600 mt-1">ATmega2560 based, integrated RAMPS compatibility.</p>
                </div>
                <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                    <div class="text-sm text-stone-500 uppercase font-bold tracking-wider mb-2">Firmware</div>
                    <div class="font-bold text-xl text-stone-800">Marlin RC7 (R-CNC)</div>
                    <p class="text-sm text-stone-600 mt-1">Modified for CNC operation (Spindle control, no extrusion).</p>
                </div>
                <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                    <div class="text-sm text-stone-500 uppercase font-bold tracking-wider mb-2">Kinematics</div>
                    <div class="font-bold text-xl text-stone-800">Cartesian</div>
                    <p class="text-sm text-stone-600 mt-1">X/Y Belt drive, Z Lead Screw (T8). NEMA 17 Steppers.</p>
                </div>
            </div>
        </header>

        <hr class="border-stone-200">

        <!-- Hardware Section -->
        <section id="section-hardware" class="scroll-mt-24">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-stone-900">Hardware Architecture</h2>
                <p class="mt-4 text-stone-600 leading-relaxed max-w-3xl">
                    The core of the system is the MKS Gen L 1.0 mainboard, which integrates an Arduino Mega 2560 and a RAMPS 1.4 shield onto a single PCB. This simplifies wiring and improves reliability. The diagram below illustrates the signal flow and power distribution designed for this laboratory activity. Click on the nodes to see connection details.
                </p>
            </div>

            <!-- Interactive Block Diagram -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                
                <!-- Diagram Visual -->
                <div class="lg:col-span-2 bg-white p-8 rounded-2xl border border-stone-200 shadow-sm relative overflow-hidden">
                    <div class="absolute top-4 right-4 text-xs font-mono text-stone-400">FIG 1.0: SYSTEM BLOCK DIAGRAM</div>
                    
                    <!-- Simplified Visual Representation using Flex/Grid -->
                    <div class="flex flex-col gap-6 items-center py-6">
                        <!-- Power & PC -->
                        <div class="flex w-full justify-between max-w-md">
                            <button onclick="updateHardwareInfo('psu')" class="circuit-node w-32 h-16 bg-amber-50 border-2 border-amber-200 rounded-lg flex items-center justify-center text-amber-800 font-bold text-sm hover:bg-amber-100 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                12V/24V PSU
                            </button>
                            <button onclick="updateHardwareInfo('pc')" class="circuit-node w-32 h-16 bg-blue-50 border-2 border-blue-200 rounded-lg flex items-center justify-center text-blue-800 font-bold text-sm hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                PC (Sender)
                            </button>
                        </div>
                        
                        <!-- Wires down -->
                        <div class="flex w-full justify-between max-w-md px-12">
                            <div class="h-8 w-0.5 bg-stone-300"></div>
                            <div class="h-8 w-0.5 bg-stone-300"></div>
                        </div>

                        <!-- Main Board -->
                        <button onclick="updateHardwareInfo('mks')" class="circuit-node w-full max-w-md h-32 bg-stone-800 text-stone-50 rounded-xl border-4 border-teal-500 flex flex-col items-center justify-center shadow-lg relative z-10 hover:bg-stone-700 focus:outline-none focus:ring-2 focus:ring-teal-500">
                            <div class="font-bold text-lg">MKS GEN L 1.0</div>
                            <div class="text-xs text-stone-400 mt-1">ATmega2560 Core</div>
                            <div class="mt-3 flex gap-2">
                                <span class="px-2 py-0.5 bg-stone-600 rounded text-xs">X-Driver</span>
                                <span class="px-2 py-0.5 bg-stone-600 rounded text-xs">Y-Driver</span>
                                <span class="px-2 py-0.5 bg-stone-600 rounded text-xs">Z-Driver</span>
                            </div>
                        </button>

                        <!-- Wires down -->
                        <div class="flex w-full justify-center gap-12 max-w-md">
                            <div class="h-8 w-0.5 bg-stone-300"></div>
                            <div class="h-8 w-0.5 bg-stone-300"></div>
                            <div class="h-8 w-0.5 bg-stone-300"></div>
                        </div>

                        <!-- Actuators -->
                        <div class="flex w-full justify-center gap-4 max-w-lg">
                            <button onclick="updateHardwareInfo('stepper')" class="circuit-node flex-1 h-20 bg-stone-100 border-2 border-stone-300 rounded-lg flex flex-col items-center justify-center text-stone-600 text-xs hover:bg-stone-200 focus:outline-none focus:ring-2 focus:ring-stone-500">
                                <span class="font-bold text-sm">X-Motor</span>
                                <span>NEMA 17</span>
                            </button>
                            <button onclick="updateHardwareInfo('stepper')" class="circuit-node flex-1 h-20 bg-stone-100 border-2 border-stone-300 rounded-lg flex flex-col items-center justify-center text-stone-600 text-xs hover:bg-stone-200 focus:outline-none focus:ring-2 focus:ring-stone-500">
                                <span class="font-bold text-sm">Y-Motor</span>
                                <span>NEMA 17</span>
                            </button>
                            <button onclick="updateHardwareInfo('stepper')" class="circuit-node flex-1 h-20 bg-stone-100 border-2 border-stone-300 rounded-lg flex flex-col items-center justify-center text-stone-600 text-xs hover:bg-stone-200 focus:outline-none focus:ring-2 focus:ring-stone-500">
                                <span class="font-bold text-sm">Z-Motor</span>
                                <span>NEMA 17</span>
                            </button>
                            <button onclick="updateHardwareInfo('spindle')" class="circuit-node flex-1 h-20 bg-red-50 border-2 border-red-200 rounded-lg flex flex-col items-center justify-center text-red-800 text-xs hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500">
                                <span class="font-bold text-sm">Spindle</span>
                                <span>775 Motor</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Detail Panel -->
                <div class="bg-stone-100 p-6 rounded-2xl border border-stone-200 h-full flex flex-col">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-3 h-3 rounded-full bg-teal-500 animate-pulse"></div>
                        <h3 class="font-bold text-lg">Component Details</h3>
                    </div>
                    <div id="hardware-detail-content" class="text-sm text-stone-600 space-y-4 flex-grow">
                        <p class="italic text-stone-400">Select a component in the diagram to view technical specifications and connection notes.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Firmware Section -->
        <section id="section-firmware" class="scroll-mt-24">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-stone-900">Firmware Logic</h2>
                <p class="mt-4 text-stone-600 leading-relaxed max-w-3xl">
                    We utilized the <strong>Marlin_RC7_R-CNC</strong> firmware branch. Unlike standard 3D printer firmware, this version is stripped of thermal protection logic (as there is no hotend) and optimized for CNC milling operations. The interactive viewer below highlights the critical modifications made in <code>Configuration.h</code>.
                </p>
            </div>

            <div class="bg-stone-900 rounded-2xl overflow-hidden shadow-lg border border-stone-700">
                <div class="flex border-b border-stone-700 bg-stone-800">
                    <button onclick="setFirmwareView('config')" id="tab-config" class="px-6 py-3 text-sm font-medium text-teal-400 border-b-2 border-teal-400 bg-stone-800/50">Configuration.h</button>
                    <button onclick="setFirmwareView('adv')" id="tab-adv" class="px-6 py-3 text-sm font-medium text-stone-400 hover:text-stone-200">Configuration_adv.h</button>
                </div>
                <div class="p-6 overflow-x-auto">
                    <pre id="firmware-code-block" class="mono text-sm leading-relaxed text-stone-300"></pre>
                </div>
                <div class="bg-stone-800 px-6 py-3 border-t border-stone-700 text-xs text-stone-400 flex justify-between">
                    <span>Marlin RC7 R-CNC Branch</span>
                    <span><span class="text-green-400">// Green</span> lines indicate enabled features</span>
                </div>
            </div>
        </section>

        <!-- Calibration Section -->
        <section id="section-calibration" class="scroll-mt-24">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                <div>
                    <h2 class="text-3xl font-bold text-stone-900">Calibration Lab</h2>
                    <p class="mt-4 text-stone-600 leading-relaxed">
                        Accurate dimensional results depend on the correct <strong>Steps Per MM</strong> settings in firmware. This value is derived from the stepper motor angle, microstepping driver settings, and the mechanics (Belt pitch or Lead Screw pitch).
                    </p>
                    
                    <div class="mt-8 bg-white p-6 rounded-2xl border border-stone-200 shadow-sm">
                        <h3 class="font-bold text-lg mb-4 text-teal-700">Steps Calculator</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Motor Step Angle</label>
                                <select id="calc-angle" class="w-full p-2 bg-stone-50 border border-stone-300 rounded font-mono text-sm focus:ring-2 focus:ring-teal-500 focus:outline-none" onchange="calculateSteps()">
                                    <option value="1.8">1.8° (200 steps/rev) - Standard</option>
                                    <option value="0.9">0.9° (400 steps/rev) - High Precision</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Driver Microstepping</label>
                                <select id="calc-micro" class="w-full p-2 bg-stone-50 border border-stone-300 rounded font-mono text-sm focus:ring-2 focus:ring-teal-500 focus:outline-none" onchange="calculateSteps()">
                                    <option value="1">1 (Full Step)</option>
                                    <option value="2">1/2 Step</option>
                                    <option value="4">1/4 Step</option>
                                    <option value="8">1/8 Step</option>
                                    <option value="16" selected>1/16 Step (Standard A4988)</option>
                                    <option value="32">1/32 Step (DRV8825)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Drive Type</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <button onclick="setDriveType('belt')" id="btn-belt" class="p-2 border rounded text-sm text-center bg-teal-50 border-teal-500 text-teal-700 font-bold">Belt (GT2)</button>
                                    <button onclick="setDriveType('screw')" id="btn-screw" class="p-2 border rounded text-sm text-center bg-stone-50 border-stone-300 text-stone-600">Lead Screw</button>
                                </div>
                            </div>
                            
                            <div id="input-belt" class="block">
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Belt Pitch (mm)</label>
                                <input type="number" id="val-pitch" value="2" class="w-full p-2 border border-stone-300 rounded font-mono text-sm" oninput="calculateSteps()">
                                <label class="block text-xs font-bold text-stone-500 uppercase mt-2 mb-1">Pulley Teeth</label>
                                <input type="number" id="val-teeth" value="20" class="w-full p-2 border border-stone-300 rounded font-mono text-sm" oninput="calculateSteps()">
                            </div>

                            <div id="input-screw" class="hidden">
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Thread Pitch (mm/rev)</label>
                                <input type="number" id="val-lead" value="8" class="w-full p-2 border border-stone-300 rounded font-mono text-sm" oninput="calculateSteps()">
                                <p class="text-xs text-stone-400 mt-1">Common T8 screw is 8mm lead (4 starts * 2mm pitch).</p>
                            </div>

                            <div class="pt-4 border-t border-stone-200">
                                <div class="text-xs font-bold text-stone-400 uppercase">Result (DEFAULT_AXIS_STEPS_PER_UNIT)</div>
                                <div class="text-3xl font-bold text-teal-600 mono mt-1">
                                    <span id="result-steps">80.00</span> <span class="text-lg text-teal-400">steps/mm</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col justify-center">
                    <h3 class="font-bold text-lg mb-4 text-stone-800">Measured Accuracy Test</h3>
                    <p class="text-sm text-stone-600 mb-6">Comparison of commanded distance (G-code) vs actual milled distance measured with digital calipers after calibration.</p>
                    
                    <div class="chart-container bg-white p-4 rounded-xl border border-stone-200 shadow-sm">
                        <canvas id="accuracyChart"></canvas>
                    </div>
                    <div class="mt-4 p-4 bg-teal-50 border border-teal-100 rounded-lg">
                        <h4 class="font-bold text-teal-800 text-sm">Analysis</h4>
                        <p class="text-sm text-teal-700 mt-1">
                            The Z-axis (Lead screw) shows higher precision due to mechanical advantage. The X/Y axes (Belts) show slight deviation (approx 0.15mm) likely due to belt tensioning issues.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Results & BOM Section -->
        <section id="section-results" class="scroll-mt-24">
            <h2 class="text-3xl font-bold text-stone-900 mb-8">Project Results & Analysis</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div class="order-2 md:order-1">
                     <h3 class="font-bold text-lg mb-4 text-stone-800">Bill of Materials (Cost Breakdown)</h3>
                     <p class="text-sm text-stone-600 mb-6">
                         Total project cost was kept low by utilizing 3D printed structural components (PLA). The electronics constitute the majority of the budget.
                     </p>
                     <div class="chart-container">
                         <canvas id="costChart"></canvas>
                     </div>
                </div>

                <div class="order-1 md:order-2 space-y-6">
                    <div class="bg-white p-6 rounded-xl border-l-4 border-teal-500 shadow-sm">
                        <h3 class="font-bold text-lg text-stone-800">Successful Outcomes</h3>
                        <ul class="mt-3 space-y-2 text-sm text-stone-600">
                            <li class="flex items-start">
                                <span class="mr-2 text-teal-500">✓</span> Functional 3-axis movement controlled via G-code Sender.
                            </li>
                            <li class="flex items-start">
                                <span class="mr-2 text-teal-500">✓</span> Successful homing sequence using mechanical endstops.
                            </li>
                            <li class="flex items-start">
                                <span class="mr-2 text-teal-500">✓</span> Milled a test pattern on copper clad board (0.5mm depth).
                            </li>
                        </ul>
                    </div>

                    <div class="bg-white p-6 rounded-xl border-l-4 border-amber-500 shadow-sm">
                        <h3 class="font-bold text-lg text-stone-800">Challenges & Future Improvements</h3>
                        <ul class="mt-3 space-y-2 text-sm text-stone-600">
                            <li class="flex items-start">
                                <span class="mr-2 text-amber-500">!</span> <strong>Z-Axis Wobble:</strong> Slight coupling misalignment caused artifacts. Requires flexible couplers.
                            </li>
                            <li class="flex items-start">
                                <span class="mr-2 text-amber-500">!</span> <strong>Spindle Runout:</strong> The generic 775 motor has high runout, limiting trace width precision to >0.5mm.
                            </li>
                            <li class="flex items-start">
                                <span class="mr-2 text-amber-500">!</span> <strong>Rigidity:</strong> 3D printed PETG parts would offer better stiffness than PLA for milling harder materials.
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="pt-10 border-t border-stone-200 text-center text-sm text-stone-500 pb-10">
            <p class="mb-2">Circuits Lab • Final Activity Report</p>
            <p>Based on <a href="https://github.com/Shortcircuitboards/PCB-CNC" target="_blank" class="text-teal-600 hover:underline">Shortcircuitboards PCB-CNC</a> & <a href="https://www.makerfr.com/en/cnc/r-cnc/r-cnc-partie-logicielle/" target="_blank" class="text-teal-600 hover:underline">MakerFr R-CNC Firmware</a>.</p>
        </footer>

    </main>

    <script>
        // --- State Management ---
        const state = {
            driveType: 'belt',
            firmwareTab: 'config',
            navOpen: false
        };

        // --- Data: Hardware Details ---
        const hardwareData = {
            'mks': {
                title: "MKS Gen L 1.0 (Mainboard)",
                desc: "The brain of the operation. It combines the functionality of an Arduino Mega 2560 and RAMPS 1.4 shield.",
                specs: [
                    "Input Voltage: 12V-24V",
                    "Processor: ATmega2560 (8-bit)",
                    "Driver Support: A4988, DRV8825, TMC2100",
                    "Connection: USB Type-B to PC"
                ]
            },
            'psu': {
                title: "Power Supply Unit (PSU)",
                desc: "Provides high current for stepper motors and the spindle.",
                specs: [
                    "Voltage: 12V DC",
                    "Current: 20A (recommended)",
                    "Connection: Direct to MKS Power Terminals"
                ]
            },
            'pc': {
                title: "Control Station (PC)",
                desc: "Sends G-code commands to the board via serial connection.",
                specs: [
                    "Software: Universal G-Code Sender or CNCjs",
                    "Baud Rate: 250000 or 115200",
                    "File Type: .nc or .gcode"
                ]
            },
            'stepper': {
                title: "NEMA 17 Stepper Motors",
                desc: "Provides precise movement for the X, Y, and Z axes.",
                specs: [
                    "Step Angle: 1.8 degrees",
                    "Holding Torque: 4.0 kg-cm (typ.)",
                    "Current: ~1.0A - 1.5A per phase"
                ]
            },
            'spindle': {
                title: "775 DC Motor (Spindle)",
                desc: "Rotates the milling bit to cut the PCB copper layer.",
                specs: [
                    "RPM: 12,000 - 20,000 RPM",
                    "Chuck: ER11 Collet (typical upgrade)",
                    "Control: MKS MOSFET output (D9)"
                ]
            }
        };

        // --- Data: Firmware Snippets ---
        const firmwareCode = {
            'config': `// Marlin Configuration.h Changes for CNC

#define MOTHERBOARD BOARD_MKS_GEN_L  // Select Board
#define BAUDRATE 115200              // Standard for CNC

// Disable Thermal Protection (No Hotend/Bed)
// #define THERMAL_PROTECTION_HOTENDS 
// #define THERMAL_PROTECTION_BED

// CNC Coordinate System
#define USE_XMIN_PLUG
#define USE_YMIN_PLUG
#define USE_ZMIN_PLUG
// #define USE_XMAX_PLUG // Disabled

// Movement Settings
#define DEFAULT_AXIS_STEPS_PER_UNIT   { 80, 80, 400, 500 }  // X, Y, Z, E
#define DEFAULT_MAX_FEEDRATE          { 300, 300, 5, 25 }   // mm/sec
#define DEFAULT_MAX_ACCELERATION      { 1000, 1000, 100, 10000 }

#define INVERT_X_DIR true // Depending on wiring
#define INVERT_Y_DIR true
#define INVERT_Z_DIR false`,
            
            'adv': `// Configuration_adv.h Settings

// Arc Support (G2/G3) - Critical for smooth CNC curves
#define ARC_SUPPORT
#define MM_PER_ARC_SEGMENT 1
#define N_ARC_CORRECTION 25

// Stepper Drivers
#define DIGIPOT_MOTOR_CURRENT { 135,135,135,135,135 } // For digital pots
// Or define driver types for newer Marlin versions:
// #define X_DRIVER_TYPE  A4988
// #define Y_DRIVER_TYPE  A4988`
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initNav();
            initCharts();
            updateHardwareInfo('mks'); // Default selection
            setFirmwareView('config');
            calculateSteps();
        });

        // --- Navigation Logic ---
        function initNav() {
            const sections = [
                { id: 'section-overview', label: 'Overview' },
                { id: 'section-hardware', label: 'Hardware' },
                { id: 'section-firmware', label: 'Firmware' },
                { id: 'section-calibration', label: 'Calibration' },
                { id: 'section-results', label: 'Results' }
            ];

            const deskNav = document.getElementById('desktop-nav');
            const mobNav = document.getElementById('mobile-nav-items');

            sections.forEach(sec => {
                // Desktop
                const dLink = document.createElement('a');
                dLink.href = `#${sec.id}`;
                dLink.className = "inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-stone-500 hover:border-teal-300 hover:text-teal-700 transition-colors";
                dLink.textContent = sec.label;
                deskNav.appendChild(dLink);

                // Mobile
                const mLink = document.createElement('a');
                mLink.href = `#${sec.id}`;
                mLink.className = "block px-3 py-2 rounded-md text-base font-medium text-stone-600 hover:text-stone-800 hover:bg-stone-50";
                mLink.textContent = sec.label;
                mLink.onclick = () => {
                    document.getElementById('mobile-menu').classList.add('hidden');
                };
                mobNav.appendChild(mLink);
            });

            document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                const menu = document.getElementById('mobile-menu');
                menu.classList.toggle('hidden');
            });
        }

        // --- Interaction: Hardware ---
        function updateHardwareInfo(key) {
            const data = hardwareData[key];
            const content = document.getElementById('hardware-detail-content');
            
            if (!data) return;

            let html = `
                <div class="animate-fade-in-up">
                    <h4 class="text-xl font-bold text-teal-800 mb-2">${data.title}</h4>
                    <p class="mb-4 leading-relaxed">${data.desc}</p>
                    <div class="bg-white p-3 rounded border border-stone-200">
                        <span class="text-xs font-bold text-stone-400 uppercase tracking-wider block mb-2">Specifications</span>
                        <ul class="space-y-1">
                            ${data.specs.map(s => `<li class="flex items-center"><span class="w-1.5 h-1.5 rounded-full bg-teal-500 mr-2"></span>${s}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            content.innerHTML = html;
        }

        // --- Interaction: Firmware ---
        function setFirmwareView(view) {
            state.firmwareTab = view;
            
            // Toggle Tab Styles
            const btnConfig = document.getElementById('tab-config');
            const btnAdv = document.getElementById('tab-adv');
            const activeClass = "text-teal-400 border-b-2 border-teal-400 bg-stone-800/50";
            const inactiveClass = "text-stone-400 hover:text-stone-200 border-b-2 border-transparent";

            if (view === 'config') {
                btnConfig.className = `px-6 py-3 text-sm font-medium ${activeClass}`;
                btnAdv.className = `px-6 py-3 text-sm font-medium ${inactiveClass}`;
            } else {
                btnConfig.className = `px-6 py-3 text-sm font-medium ${inactiveClass}`;
                btnAdv.className = `px-6 py-3 text-sm font-medium ${activeClass}`;
            }

            // Update Content with highlighting logic (naive regex for comments)
            let code = firmwareCode[view];
            // Simple syntax highlighting for visual effect
            code = code.replace(/(\/\/.*)/g, '<span class="text-stone-500">$1</span>');
            code = code.replace(/(#define)/g, '<span class="text-purple-400">$1</span>');
            code = code.replace(/(\d+)/g, '<span class="text-orange-300">$1</span>');
            
            document.getElementById('firmware-code-block').innerHTML = code;
        }

        // --- Interaction: Calibration Calculator ---
        function setDriveType(type) {
            state.driveType = type;
            const beltInput = document.getElementById('input-belt');
            const screwInput = document.getElementById('input-screw');
            const btnBelt = document.getElementById('btn-belt');
            const btnScrew = document.getElementById('btn-screw');

            if (type === 'belt') {
                beltInput.classList.remove('hidden');
                beltInput.classList.add('block');
                screwInput.classList.add('hidden');
                screwInput.classList.remove('block');
                
                btnBelt.className = "p-2 border rounded text-sm text-center bg-teal-50 border-teal-500 text-teal-700 font-bold shadow-sm";
                btnScrew.className = "p-2 border rounded text-sm text-center bg-stone-50 border-stone-200 text-stone-600 hover:bg-stone-100";
            } else {
                beltInput.classList.add('hidden');
                beltInput.classList.remove('block');
                screwInput.classList.remove('hidden');
                screwInput.classList.add('block');

                btnScrew.className = "p-2 border rounded text-sm text-center bg-teal-50 border-teal-500 text-teal-700 font-bold shadow-sm";
                btnBelt.className = "p-2 border rounded text-sm text-center bg-stone-50 border-stone-200 text-stone-600 hover:bg-stone-100";
            }
            calculateSteps();
        }

        function calculateSteps() {
            const angle = parseFloat(document.getElementById('calc-angle').value);
            const micro = parseInt(document.getElementById('calc-micro').value);
            
            const stepsPerRev = 360 / angle;
            let result = 0;

            if (state.driveType === 'belt') {
                const pitch = parseFloat(document.getElementById('val-pitch').value);
                const teeth = parseFloat(document.getElementById('val-teeth').value);
                // Formula: (Steps/Rev * Microsteps) / (Pitch * Teeth)
                const mmPerRev = pitch * teeth;
                if(mmPerRev > 0) result = (stepsPerRev * micro) / mmPerRev;
            } else {
                const lead = parseFloat(document.getElementById('val-lead').value);
                // Formula: (Steps/Rev * Microsteps) / Lead
                if(lead > 0) result = (stepsPerRev * micro) / lead;
            }

            document.getElementById('result-steps').textContent = result.toFixed(2);
        }

        // --- Charts (Chart.js) ---
        function initCharts() {
            // 1. Accuracy Chart (Bar)
            const ctxAccuracy = document.getElementById('accuracyChart').getContext('2d');
            new Chart(ctxAccuracy, {
                type: 'bar',
                data: {
                    labels: ['X Axis (20mm)', 'Y Axis (20mm)', 'Z Axis (5mm)'],
                    datasets: [
                        {
                            label: 'Commanded Distance',
                            data: [20, 20, 5],
                            backgroundColor: '#e7e5e4', // stone-200
                            borderColor: '#a8a29e',
                            borderWidth: 1
                        },
                        {
                            label: 'Measured Actual',
                            data: [19.85, 19.90, 4.98], // Simulated lab data
                            backgroundColor: '#0d9488', // teal-600
                            borderColor: '#0f766e',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Distance (mm)' } }
                    },
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // 2. Cost Chart (Pie)
            const ctxCost = document.getElementById('costChart').getContext('2d');
            new Chart(ctxCost, {
                type: 'doughnut',
                data: {
                    labels: ['MKS Gen L + Drivers', 'Motors (3x NEMA 17)', 'Linear Hardware (Rods/Screws)', '3D Printed Filament', 'Spindle & PSU'],
                    datasets: [{
                        data: [25, 30, 20, 10, 15], // Approximate percentages based on typical BOM
                        backgroundColor: [
                            '#0d9488', // teal-600
                            '#2dd4bf', // teal-400
                            '#fbbf24', // amber-400
                            '#a8a29e', // stone-400
                            '#ef4444'  // red-500
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
